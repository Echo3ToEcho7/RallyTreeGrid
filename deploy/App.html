<!DOCTYPE html>
<html>
<head>
    <title>TreeGrid</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk-debug.js?wsapiVersion=1.39"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            (function (global) {
              Ext.define("Rally.data.WsapiTreeProxy", {
                requires: ["Rally.data.WsapiReader"],
            
                extend: "Rally.data.WsapiRestProxy",
            
                rootArtifacts: null, //["HierarchicalRequirement"],
                childArtifacts: null, //["HierarchicalRequirement"],
                isRoot: false,
                model: null,
            
                constructor: function ctor(config) {
                  var me = this;
            
                  Ext.apply(me, config);
                  me.reader = Ext.create("Rally.data.WsapiReader",  {
                    root: "HierarchicalRequirement",
                    totalProperty: "TotalResultCount"
                  });
            
                  console.log("For Artifacts", me.rootArtifacts, me.childArtifacts);
                  //debugger;
                },
            
                read: function read(operation, callback, scope) {
                  var me = this;
            
                  console.log("Calling WTP Read", operation);
            
                  if (me.isRoot) {
                    me._readRoot(operation, callback, scope);
                  } else {
                    me._readChildren(operation, callback, scope);
                  }
                },
            
                _readRoot: function _readRoot(operation, callback, scope) {
                  var loadedArtifacts = {},
                      me = this,
                      processCB = Ext.bind(this._processResults, {loadedArtifacts: loadedArtifacts, operation: operation, callback: callback, scope: scope}),
                      i= 0, ii = me.rootArtifacts.length;
            
                  console.log("Reading Root");
            
                  for (; i < ii; i++) {
                    loadedArtifacts[me.rootArtifacts[i].toLowerCase()] = 0;
            
                    (function iHateJS(type) {
                      Rally.data.TreeModelFactory.getModel({
                        type: type,
                        canExpandFn: me.canExpandFn,
                        success: function onSuccess(model) {
                          Ext.create("Rally.data.WsapiDataStore", {
                            autoLoad: true,
                            model: model,
                            listeners: {
                              load: function loaded(store, data, success) {
                                processCB(store, data, type);
                              }
                            }
                          });
                        }
                      });
                    }(me.rootArtifacts[i].toLowerCase()));
                  }
                },
            
                _readChildren: function _readChildren(operation, callback, scope) {
                  var loadedArtifacts = {},
                      me = this,
                      processCB = Ext.bind(this._processResults, {loadedArtifacts: loadedArtifacts, operation: operation, callback: callback, scope: scope}),
                      i= 0, ii = me.childArtifacts.length;
            
                  console.log("Reading Children");
            
                  for (; i < ii; i++) {
                    //console.log("Fetching children of type", me.childArtifacts[i], i, ii);
                    loadedArtifacts[me.childArtifacts[i].toLowerCase()] = 0;
            
                    (function iHateJS(type) {
                      Rally.data.TreeModelFactory.getModel({
                        //canExpandFn: me.canExpandFn,
                        type: type,
                        success: function onSuccess(model) {
            
                          Rally.data.ModelFactory.getModel({
                            type: type,
                            success: function onNormSuccess(rmodel) {
            
                              var whichModel = model;
            
                              if (type.indexOf("feature") != -1) {
                                //whichModel = rmodel;
                                //debugger;
                              }
            
                          Ext.create("Rally.data.WsapiDataStore", {
                            autoLoad: true,
                            filters: [{
                              property: "Parent",
                              value: operation.node.raw._ref
                            }],
                            model: whichModel,
                            listeners: {
                              load: function loaded(store, data, success) {
                                console.log("Loaded Children", type, store, data, success);
                                processCB(store, data, type);
                              }
                            }
                          });
            
                            }
                          });
                        }
                      });
                    }(me.childArtifacts[i].toLowerCase()));
                  }
            
                },
            
                _processResults: function (store, data, artifactType) {
                  console.log("Loaded " + artifactType, data, this);
            
                  if (this.loadedArtifacts[artifactType.toLowerCase()]) {
                    return;
                  }
            
                  if (typeof this.operation.resultSet === "undefined") {
                    this.operation.resultSet = [];
                  }
            
                  var i, ii, k, done = true;
            
                  if (data) {
                    for (i = 0, ii = data.length; i < ii; i ++) {
                      this.operation.resultSet.push(data[i]);
                    }
                  }
            
                  this.loadedArtifacts[artifactType] = 1;
            
                  for (k in this.loadedArtifacts) {
                    if (this.loadedArtifacts.hasOwnProperty(k)) {
                      done = done && this.loadedArtifacts[k];
                    }
                  }
            
                  if (done) {
                    console.log("Done");
            
                    this.operation.records = this.operation.resultSet;
                    this.operation.setCompleted();
                    this.operation.setSuccessful();
            
                    console.dir(this.operation);
                    //debugger;
            
                    Ext.callback(this.callback, this.scope || me, [this.operation]);
                  }
                }
            
                //getProxy: function () {
                  //return {buildExtractors: function() {}};
                //}
              });
            })(this);
            (function (global) {
              var trm = Ext.define("Rally.data.TreeRootModel", {
                requires: [
                  "Ext.data.NodeInterface",
                  "Rally.data.WsapiTreeProxy"
                ],
            
                extend: "Ext.data.Model",
            
                constructor: function ctor(options) {
                  var me = this,
                      o = {};
            
                  Ext.apply(o, {
                    rootArtifacts: ["HierarchicalRequirement", "Defect"]
                  });
                  Ext.apply(o, options);
            
                  console.log("TreeRootModel", o, options);
            
                  me.proxy = Ext.create("Rally.data.WsapiTreeProxy", {
                    rootArtifacts: o.rootArtifacts,
                    isRoot: true
                  });
            
                  me.callParent([options]);
                }
              });
            
              Ext.data.NodeInterface.decorate(trm);
            })(this);
            (function(global) {
            
              Ext.define('Rally.data.TreeModelFactory', {
                requires: ['Ext.data.NodeInterface', 'Rally.data.ModelFactory'],
            
                singleton: true,
            
                getModel: function getModel(options) {
                  var me = this,
                      cb = options.success || function noop() {},
                      canExpandFn = options.canExpandFn;
            
                  delete options.canExpandFn;
            
                  options.success = function onTreeModelSuccess(model) {
                    var treeModel = me.createTreeModel(model, canExpandFn);
                    cb(treeModel);
                  };
            
                  //debugger;
            
                  Rally.data.ModelFactory.getModel(options);
            
                },
            
                createTreeModel: function createTreeModel(baseModel, canExpandFn) {
                    var o = {},
                        treeModel;
            
                    if (typeof canExpandFn !== "function") {
                      canExpandFn = function defaultCanExpandFn(rec) {
                        console.log("Checking Can Expand");
                        var names = rec.self.getChildFieldNames(),
                            canExpand = true,
                            i, ii;
            
                        console.log("Can Expand Fields", names);
            
                        for (i = 0, ii = names.length; i < ii; i++) {
                          if (rec.raw.hasOwnProperty(names[i])) {
                            canExpand = canExpand && rec.raw[names[i]].length > 0;
                          }
                        }
            
                        return canExpand;
                      };
                    }
            
                    Ext.applyIf(o, {
                      extend: baseModel,
            
                      constructor: function ctor(config) {
                        console.log("Tree Model Config options", config);
                        this.callParent([config]);
                      },
            
                      statics: {
                        canExpandFn: canExpandFn,
            
                        getParentFieldNames: function getParentFieldNames() {
                          var typeName = baseModel.typeName.toLowerCase();
            
                          if ({"task": 1, "testcase": 1}.hasOwnProperty(typeName)) {
                            return ["WorkItem"];
                          } else if ({"defect": 1}.hasOwnProperty(typeName)) {
                            return ["Requirement"];
                          } else if ({"testcasestep": 1}.hasOwnProperty(typeName)) {
                            return ["TestCase"];
                          } else if ({"hierarchicalrequirement": 1}.hasOwnProperty(typeName)) {
                            return ["Parent", "PortfolioItem"];
                          } else {
                            return ["Parent"];
                          }
                        },
            
                        getChildFieldNames: function getChildFieldNames() {
                          var typeName = baseModel.typeName.toLowerCase();
            
                          if (typeName === "hierarchicalrequirement") {
                            return ["Tasks", "Children", "Defects", "TestCases"];
                          } else if (typeName === "defectsuite") {
                            return ["Defects", "Tasks"];
                          } else if (typeName === "defect") {
                            return ["Tasks"];
                          } else if (typeName === "testcase") {
                            return ["TestCaseSteps"];
                          } else if (typeName.indexOf("portfolioitem") !== -1) {
                            return ["Children", "UserStories"];
                          } else {
                            return ["Children"];
                          }
                        }
                      }
                    });
            
                    treeModel = Ext.define(baseModel.modelName + ".TreeModel", o);
            
                    console.log("Base model");
                    console.dir(baseModel);
            
                    Ext.data.NodeInterface.decorate(treeModel);
            
                    var i = 0, fields = treeModel.getFields(), ii = fields.length;
            
                    for (; i < ii; i++) {
                      if ({leaf: 1}.hasOwnProperty(fields[i].name)) {
                        console.log("Adding leaf conversion");
                        fields[i].convert = function (v, rec) {
                          console.log("Converting leaf", v, rec);
                          console.dir(rec);
                          return !rec.self.canExpandFn(rec);
                        };
                      }
                    }
            
                    treeModel.applyField;
            
                    return treeModel;
                }
              });
            
            })(this);
            (function (global) {
              Ext.define("Rally.data.WsapiTreeStore", {
                extend: "Ext.data.TreeStore",
            
                rootArtifacts: ["HierarchicalRequirement", "Defect"],
                childArtifacts: ["HierarchicalRequirement", "Task"],
            
                constructor: function wsapi_tree_store_ctor(config) {
                  var me = this,
                      trmConfig = {};
            
            
                  Ext.apply(me, config);
            
                  console.log("WsapiTreeStore Root Artifacts", me.rootArtifacts);
            
                  me.root = Ext.create("Rally.data.TreeRootModel", {
                    rootArtifacts: me.rootArtifacts
                  });
            
                  //me.proxy = Ext.create("Rally.data.WsapiTreeProxy", {
                    //rootArtifact: me.rootArtifacts,
                    //childArtifacts: me.childArtifacts
                  //});
            
                  me.callParent([config]);
            
                },
            
                load: function load(options) {
                  console.log("Tree Store Load Options");
                  console.dir(options);
                  console.log("Is Node Loaded?", options.node.isLoaded());
            
                  var me = this;
            
                  options.callback = function t() {
                    console.log("Tree Loaded", arguments);
                  };
            
                  me.setProxy(Ext.create("Rally.data.WsapiTreeProxy", {
                    model: options.node,
                    rootArtifacts: me.rootArtifacts,
                    childArtifacts: me.childArtifacts,
                    isRoot: me.getRootNode().modelName === options.node.modelName,
                    canExpandFn: me.canExpandFn
                  }));
            
                  me.callParent([options]);
                }
              });
            }(this));
            (function (global) {
              Ext.override(Rally.env.Server, {
                getWsapiUrl: function(version) {
                  return this.getContextUrl() + "/webservice/1.39";
                }
              });
            
              Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
            
                launch: function() {
                  var store = Ext.create('Rally.data.WsapiTreeStore', {
                    rootArtifacts: ['portfolioitem/theme'],
                    childArtifacts: ['portfolioitem/initiative', 'portfolioitem/feature', 'hierarchicalrequirement'],
                    //canExpandFn: function(rec) {
                      
                    //},
                    listeners: {
                      append: function appened() {
                        console.log("Appending Data");
                        console.dir(arguments);
                      }
                    }
                  });
            
                  this.add(Ext.create('Ext.tree.Panel', {
                    title: 'Simple Tree',
                    width: '100%',
                    height: '100%',
                    componentCls: 'rally-grid',
                    store: store,
                    rootVisible: false,
                    columns: [{
                      xtype: 'treecolumn',
                      text: 'Name',
                      dataIndex: 'Name',
                      flex: 2
                    }, {
                      text: 'Schedule State',
                      dataIndex: 'ScheduleState',
                      flex: 1
                    }],
                    listeners: {
                      afteritemexpand: function (node, idx, elt, oOpt) {
                        console.log("Expaned node", node);
                      },
                      load: function (store, node, recs, success, oOpt) {
                        console.log("Loaded", success, recs, node);
                        node.expand();
                      }
                    }
                  }));
                }
              });
            }(this));

            Rally.launchApp('CustomApp', {
                name: 'TreeGrid'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
